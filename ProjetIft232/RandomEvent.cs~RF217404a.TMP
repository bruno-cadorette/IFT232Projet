using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using ProjetIft232.Buildings;

namespace ProjetIft232
{
    public class Effect
    {
        public Resources resource { get; private set; }
        public int nbBuildDestroyed { get; private set; }
        public string description { get; private set; }

        public Effect(Resources rsc, int nb, string desc)
        {
            resource = rsc;
            nbBuildDestroyed = nb;
            description = desc;

        }
        public Effect(int nb, string desc)
        {
            resource = new Resources{};
            nbBuildDestroyed = nb;
            description = desc;

        }

        public Effect(Resources rsc, string desc)
        {
            resource = rsc;
            nbBuildDestroyed = 0;
            description = desc;

        }

        public string Apply(City city)
        {
            Random random = new Random();
            int bati;
            string result = "- ";
            result += description;
            for (int i = 0; i < (int) ResourcesType.End; i++)
            {
                resource[(ResourcesType)i] = resource[(ResourcesType)i] * city.Ressources[(ResourcesType)i] / 100;
            }
                city.RemoveResources(resource);
            for (int i = 0; i < nbBuildDestroyed; i++)
                if (city.Buildings.Count > 0)
                {
                    bati = random.Next(0, city.Buildings.Count - 1);
                    result += "\n" + city.Buildings[bati].Name + " a été détruit.";
                    city.RemoveBuilding(bati);
                }
            return result; 

        }


    }

    public class Event
    {
        public string name {get; private set;}
        public int counter { get; private set; }
        public Effect normalEffect { get; private set; }
        public Effect counterEffect { get; private set; }

        public Event(string nm,  int ct, Effect ef1, Effect ef2)
        {
            name =nm;
            counter = ct;
            normalEffect = ef1;
            counterEffect = ef2;

        }

        public Event(string nm, Effect ef1)
        {
            name =nm;
            counter = -1;
            normalEffect = ef1;
            counterEffect = null;

        }



    }

    public class RandomEvent
    {
        public Dictionary<Event, int> events = new Dictionary<Event, int>();
        //Exemple de tuple : 
        // {Meteores,((Ressources, (nombre de batiments détruits, description))}
        // {Meteores,(((Ressources, (( nombre de batiments détruits,description),(batiment requis, antidescription))))}
        public static Dictionary<string, Event> cost = new Dictionary<string, Event>()
        {
   /*       {"Zombies", Tuple.Create<Resources, Tuple<int, string>>(new Resources(0,0,1000,0,200), Tuple.Create<int, string>(0,"Les zombies attaquent ! Coureeeeeeeez !"))},
            {"Ebola", Tuple.Create<Resources, Tuple<int, string>>(new Resources(0,0,200,0,1000), Tuple.Create<int, string>(1,"Il fallait se laver les mains..."))},
            {"Extra-terrestres", Tuple.Create<Resources, Tuple<int, string>>(new Resources(100,0,0,200,200), Tuple.Create<int, string>(1,"Une soucoupe est passee et a recupere quelques ressources..."))},
            {"Chevres enragees", Tuple.Create<Resources, Tuple<int, string>>(new Resources(0,0,0,0,500), Tuple.Create<int, string>(1,"On nous attaque ! Une troupe de chevres enragees met nos vies en danger !"))},
            {"Singes malicieux", Tuple.Create<Resources, Tuple<int, string>>(new Resources(0,3000,0,0,0), Tuple.Create<int, string>(0,"Ces singes etaient mignons... Mais ils nous ont vole notre or !"))},
            {"Seisme", Tuple.Create<Resources, Tuple<int, string>>(new Resources(0,0,0,-1000,500), Tuple.Create<int, string>(2,"Ca tremble ! Ca tremble ! "))},
            {"Godzilla", Tuple.Create<Resources, Tuple<int, string>>(new Resources(500,200,500,500,200), Tuple.Create<int, string>(3,"J'ai cru voir un gros lezard se balader dans la ville..."))},
            {"Mode des bijoux en or", Tuple.Create<Resources, Tuple<int, string>>(new Resources(0,1000,0,0,0), Tuple.Create<int, string>(3,"Mon precieux..."))},
            {"Pluie feconde", Tuple.Create<Resources, Tuple<int, string>>(new Resources(0,0,-1000,0,0), Tuple.Create<int, string>(0,"Une pluie ameliorant les recoltes."))},
            {"Decouverte d'un leprechaun", Tuple.Create<Resources, Tuple<int, string>>(new Resources(0,-2000,0,0,0), Tuple.Create<int, string>(0,"On a trouve un leprechaun ! Ce petit homme faisait une drole de tete quand on a requisitionne son or ! :D"))},
            {"Incendie quantique", Tuple.Create<Resources, Tuple<int, string>>(new Resources(-1000,0,0,0,0), Tuple.Create<int, string>(0,"J'aurai jure que tout brulait..."))},
            {"Baby Boom", Tuple.Create<Resources, Tuple<int, string>>(new Resources(0,0,1000,0,-600), Tuple.Create<int, string>(0,"Tout le monde a voulu imiter des lapins, c'est bien fait pour eux."))}
   */
        };
                                                                            // wood   gold    meat   rock    population
        public RandomEvent()
        {
            events.Add(new Event("Météorites", 0,new Effect(new Resources{Wood = 90 , Gold = 30, Meat = 40, Population = 50},3,"C'est un oiseau ! Non ! C'est un avion ! Ah non, une meteorite..."), new Effect(1,"Waouh ! Sauvé par la maison ! :D")),2);
            events.Add(new Event("Zombies", 5, new Effect(new Resources{ Meat = 70, Population = 35 },0, "Les zombies attaquent ! Coureeeeeeeez !"), new Effect(new Resources{Meat = 40 ,Population = 10},0,"Grâce à la caserne, les villageois on pu se défendre !")),5);
            events.Add(new Event("Ebola", 6, new Effect(new Resources { Meat = 20, Population = 70 }, 1, "Un ebola sauvage apparait dans les hautes herbes ! Gotta catch'em all ! :D"), new Effect(new Resources{Population = 8}, "L'hôpital nous a tous sauvé ! Gloire à l'hôpital ! ")),1);
            events.Add(new Event("Extra-terrestres", new Effect(new Resources{Wood = 10, Rock = 10, Population = 2},1,"Une soucoupe est passee et a recupere quelques ressources...")),14);
            events.Add(new Event("Chevres enragees", 1, new Effect(new Resources{Population = 90}, 1, "On nous attaque ! Une troupe de chevres enragees met nos vies en danger !"),new Effect(new Resources{Meat = -50},"Elles ont trouvees dans la ferme la sedentarite qui leur manquait")),5);
            events.Add(new Event("Singes malicieux",new Effect(new Resources{Gold = 40},"Ces singes etaient mignons... Mais ils nous ont vole notre or !")),12);
            events.Add(new Event("Seisme",new Effect(new Resources{Rock = -100 , Population = 26},2,"Ca tremble ! Ca tremble ! ")),8);
            events.Add(new Event("Godzilla", new Effect(new Resources {Wood = 95, Gold = 95,Rock = 95,Meat = 99, Population = 98 }, 3, "J'ai cru voir un gros lezard se balader dans la ville...")),1);
            events.Add(new Event("Mode des bijoux en or", 7, new Effect(new Resources{Gold = 35}, 0, "Mon precieux..."), new Effect(new Resources{}, "Heureusement, le marché était là pour approvisionner la population avant qu'ils piochent dans les réserves...")),19);
            events.Add(new Event("Pluie feconde", new Effect(new Resources{Meat = -50}, 0, "Une pluie a amélioré les récoltes chef !")),20);
            events.Add(new Event("Decouverte d'un leprechaun", new Effect(new Resources{Gold = -200}, 0, "On a trouve un leprechaun ! Ce petit homme faisait une drole de tete quand on a requisitionne son or ! :D")),4);
            events.Add(new Event("Incendie quantique", new Effect(new Resources{Wood = -33},1,"J'aurai jure qu'il y avait un bâtiment ici... Pas une forêt.")),4);
            events.Add(new Event("Baby Boom", new Effect(new Resources{Meat = 50,Population = -50},0,"Tout le monde a voulu imiter des lapins, c'est bien fait pour eux.")),10);
        }
        public  String Next(City city)
        {
            Random random = new Random();
            Event ev = null;

            foreach (Event e in events.Keys)
            {
                int nombre = random.Next(0, 99);
                if (nombre < events[e]) {
                    ev = e;
                    break;
                }
            }
            if (ev != null) { 
                string result = "Votre ville a subi : " + ev.name + "\n";
                if (!city.IsBuilt((int)ev.counter))
                {

                    return result + ev.normalEffect.Apply(city);
                 }
                 else
                {
                  return result + ev.counterEffect.Apply(city);
                }
           }
            return "Vous avez eu peur hein? Ben il ne s'est rien passe...\n"; 
        }
        
    }
}
